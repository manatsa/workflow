import{a as et,b as tt,c as nt}from"./chunk-IENNPC4K.js";import{a as Ke,b as ze,c as Ze,d as Qe}from"./chunk-T3UOS2VF.js";import{a as Xe,b as je}from"./chunk-A65RCWZW.js";import"./chunk-MS4AQ6UA.js";import{a as Ge,b as Je}from"./chunk-HWGXTLQG.js";import{c as oe}from"./chunk-WOKYK45J.js";import"./chunk-7XCE4O6Y.js";import{d as re}from"./chunk-GXBSGI7M.js";import{a as We,b as Le,c as Ve,d as $e,e as Ye}from"./chunk-ZOGMIJEM.js";import{a as Be,b as He}from"./chunk-WS3LSTPP.js";import"./chunk-DX3LX2XG.js";import{b as Ue,c as Pe}from"./chunk-TN4AHATL.js";import"./chunk-HAECDJ4T.js";import{a as be,b as ke}from"./chunk-5IID7QRZ.js";import{b as Ae,e as Re,f as we,i as Ie,j as Ne,l as Oe,m as ye}from"./chunk-QPNPC3UF.js";import{d as ae,f as J,h as le,i as se,m as ce,n as de,p as me,q as ue,t as _e,v as pe}from"./chunk-PTVBPAL6.js";import{a as xe,b as Te,c as Fe,d as Me,f as ve,h as De}from"./chunk-FDHOQCIP.js";import{a as qe}from"./chunk-72SFJ5UH.js";import"./chunk-SPXEAC7E.js";import"./chunk-CRE6EOZT.js";import"./chunk-YPEK7DFO.js";import{a as Se}from"./chunk-4ZZG7ICJ.js";import{a as te,c as ne,g as ie}from"./chunk-7HWBNCDZ.js";import{p as ee,ta as fe,ua as Ee,va as he,wa as Ce,ya as ge}from"./chunk-SKGZNIDJ.js";import{Ac as Q,B as z,Cb as A,Db as q,Eb as w,H,Hb as v,Kb as y,Lb as b,Mb as f,Nb as d,Ob as I,Sb as Y,Wb as k,Xb as E,a as U,b as V,c as $,cb as s,ec as G,fc as C,gc as M,hb as L,hc as B,oa as P,ob as Z,pa as W,ub as D}from"./chunk-2CONVDTD.js";var X=(r,h)=>h.id,j=(r,h)=>h.value,it=(r,h)=>h.name;function rt(r,h){r&1&&(f(0,"div",6),I(1,"mat-spinner",8),f(2,"p"),C(3,"Loading form..."),d()())}function ot(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function at(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function lt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,ot,2,0,"span",25),d(),I(5,"input",26),d(),D(6,at,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?6:-1)}}function st(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function ct(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function dt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,st,2,0,"span",25),d(),I(5,"textarea",28),d(),D(6,ct,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?6:-1)}}function mt(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function ut(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function _t(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,mt,2,0,"span",25),d(),I(5,"input",29),d(),D(6,ut,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?6:-1)}}function pt(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function ft(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function Et(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,pt,2,0,"span",25),d(),I(5,"input",29),f(6,"span",30),C(7,"$\xA0"),d()(),D(8,ft,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("readonly",n.isFieldReadonly(t)),s(3),v(n.hasFieldError(t)?8:-1)}}function ht(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function Ct(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function gt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,ht,2,0,"span",25),d(),I(5,"input",31),d(),D(6,Ct,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?6:-1)}}function St(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function xt(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function Tt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,St,2,0,"span",25),d(),I(5,"input",32),d(),D(6,xt,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?6:-1)}}function Ft(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function Mt(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function vt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,Ft,2,0,"span",25),d(),I(5,"input",33)(6,"mat-datepicker-toggle",34)(7,"mat-datepicker",35,0),d(),D(9,Mt,2,1,"div",27),d()),r&2){let t=G(8),n=E().$implicit,o=E(3);s(),w("field-invalid",o.hasFieldError(n)),s(2),M(n.label),s(),v(o.isFieldRequired(n)?4:-1),s(),A("matDatepicker",t)("formControlName",n.name)("readonly",o.isFieldReadonly(n)),s(),A("for",t)("disabled",o.isFieldReadonly(n)),s(),A("disabled",o.isFieldReadonly(n)),s(2),v(o.hasFieldError(n)?9:-1)}}function Dt(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function At(r,h){if(r&1&&(f(0,"mat-option",37),C(1),d()),r&2){let t=h.$implicit;A("value",t.value),s(),M(t.label)}}function Rt(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function wt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,Dt,2,0,"span",25),d(),f(5,"mat-select",36),y(6,At,2,2,"mat-option",37,j),d()(),D(8,Rt,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("disabled",n.isFieldReadonly(t)),s(),b(t.options),s(2),v(n.hasFieldError(t)?8:-1)}}function It(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function Nt(r,h){if(r&1&&(f(0,"mat-radio-button",41),C(1),d()),r&2){let t=h.$implicit,n=E(2).$implicit,o=E(3);A("value",t.value)("disabled",o.isFieldReadonly(n)),s(),M(t.label)}}function Ot(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function yt(r,h){if(r&1&&(f(0,"div",38)(1,"label",39),C(2),D(3,It,2,0,"span",25),d(),f(4,"mat-radio-group",40),y(5,Nt,2,3,"mat-radio-button",41,j),d(),D(7,Ot,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);w("has-error",n.hasFieldError(t)),s(2),B("",t.label," "),s(),v(n.isFieldRequired(t)?3:-1),s(),A("formControlName",t.name)("disabled",n.isFieldReadonly(t)),s(),b(t.options),s(2),v(n.hasFieldError(t)?7:-1)}}function bt(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function kt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-checkbox",40),C(2),d(),D(3,bt,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),A("formControlName",t.name)("disabled",n.isFieldReadonly(t)),s(),M(t.label),s(),v(n.hasFieldError(t)?3:-1)}}function Ut(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function Pt(r,h){if(r&1&&(f(0,"mat-chip"),C(1),d()),r&2){let t=h.$implicit;s(),M(t.name)}}function Wt(r,h){if(r&1&&(f(0,"div",44),y(1,Pt,2,1,"mat-chip",null,it),d()),r&2){let t=E(2).$implicit,n=E(3);s(),b(n.selectedFiles[t.name])}}function Lt(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function Vt(r,h){if(r&1){let t=Y();f(0,"div",42)(1,"label",39),C(2),D(3,Ut,2,0,"span",25),d(),f(4,"input",43),k("change",function(o){P(t);let m=E().$implicit,_=E(3);return W(_.onFileSelect(o,m.name))}),d(),D(5,Wt,3,0,"div",44)(6,Lt,2,1,"div",27),d()}if(r&2){let t=E().$implicit,n=E(3);w("has-error",n.hasFieldError(t)),s(2),B("",t.label," "),s(),v(n.isFieldRequired(t)?3:-1),s(),A("multiple",t.multiple)("disabled",n.isFieldReadonly(t)),s(),v(n.selectedFiles[t.name]&&n.selectedFiles[t.name].length>0?5:-1),s(),v(n.hasFieldError(t)?6:-1)}}function $t(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function Yt(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function Bt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,$t,2,0,"span",25),d(),I(5,"input",45),d(),D(6,Yt,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?6:-1)}}function Ht(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),d(),I(4,"input",26),d()()),r&2){let t=E().$implicit,n=E(3);s(3),M(t.label),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("readonly",n.isFieldReadonly(t))}}function qt(r,h){if(r&1&&(f(0,"div",21),D(1,lt,7,8,"div",22)(2,dt,7,8,"div",22)(3,_t,7,8,"div",22)(4,Et,9,8,"div",22)(5,gt,7,8,"div",22)(6,Tt,7,8,"div",22)(7,vt,10,11,"div",22)(8,wt,9,8,"div",22)(9,yt,8,7,"div",23)(10,kt,4,4,"div",22)(11,Vt,7,8,"div",24)(12,Bt,7,8,"div",22)(13,Ht,5,4,"div",22),d()),r&2){let t,n=h.$implicit;q("grid-column","span "+(n.columnSpan||2)),s(),v((t=n.type)==="TEXT"?1:t==="TEXTAREA"?2:t==="NUMBER"?3:t==="CURRENCY"?4:t==="EMAIL"?5:t==="PHONE"?6:t==="DATE"?7:t==="SELECT"?8:t==="RADIO"?9:t==="CHECKBOX"?10:t==="FILE"?11:t==="URL"?12:13)}}function Gt(r,h){if(r&1&&(f(0,"mat-card",10)(1,"mat-card-content")(2,"div",19),y(3,qt,14,3,"div",20,X),d()()()),r&2){let t=E(2);s(3),b(t.getUngroupedFields())}}function Jt(r,h){if(r&1&&(f(0,"mat-panel-description"),C(1),d()),r&2){let t=E().$implicit;s(),M(t.description)}}function Xt(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function jt(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function Kt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,Xt,2,0,"span",25),d(),I(5,"input",26),d(),D(6,jt,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("placeholder",t.placeholder||"")("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?6:-1)}}function zt(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function Zt(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function Qt(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,zt,2,0,"span",25),d(),I(5,"textarea",47),d(),D(6,Zt,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?6:-1)}}function en(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function tn(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function nn(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,en,2,0,"span",25),d(),I(5,"input",48),d(),D(6,tn,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?6:-1)}}function rn(r,h){r&1&&(f(0,"span",25),C(1,"*"),d())}function on(r,h){if(r&1&&(f(0,"mat-option",37),C(1),d()),r&2){let t=h.$implicit;A("value",t.value),s(),M(t.label)}}function an(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function ln(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),D(4,rn,2,0,"span",25),d(),f(5,"mat-select",40),y(6,on,2,2,"mat-option",37,j),d()(),D(8,an,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),v(n.isFieldRequired(t)?4:-1),s(),A("formControlName",t.name)("disabled",n.isFieldReadonly(t)),s(),b(t.options),s(2),v(n.hasFieldError(t)?8:-1)}}function sn(r,h){if(r&1&&(f(0,"div",27),C(1),d()),r&2){let t=E(2).$implicit,n=E(3);s(),M(n.getFieldErrorMessage(t))}}function cn(r,h){if(r&1&&(f(0,"div",22)(1,"mat-form-field",12)(2,"mat-label"),C(3),d(),I(4,"input",49),d(),D(5,sn,2,1,"div",27),d()),r&2){let t=E().$implicit,n=E(3);s(),w("field-invalid",n.hasFieldError(t)),s(2),M(t.label),s(),A("formControlName",t.name)("readonly",n.isFieldReadonly(t)),s(),v(n.hasFieldError(t)?5:-1)}}function dn(r,h){if(r&1&&(f(0,"div",21),D(1,Kt,7,8,"div",22)(2,Qt,7,7,"div",22)(3,nn,7,7,"div",22)(4,ln,9,7,"div",22)(5,cn,6,6,"div",22),d()),r&2){let t,n=h.$implicit;q("grid-column","span "+(n.columnSpan||2)),s(),v((t=n.type)==="TEXT"?1:t==="TEXTAREA"?2:t==="NUMBER"?3:t==="SELECT"?4:5)}}function mn(r,h){if(r&1&&(f(0,"mat-card",11)(1,"mat-expansion-panel",46)(2,"mat-expansion-panel-header")(3,"mat-panel-title"),C(4),d(),D(5,Jt,2,1,"mat-panel-description"),d(),f(6,"div",19),y(7,dn,6,3,"div",20,X),d()()()),r&2){let t=h.$implicit,n=E(2);s(),A("expanded",!t.collapsed)("hideToggle",!t.collapsible),s(3),M(t.title),s(),v(t.description?5:-1),s(2),b(n.getFieldsInGroup(t.id))}}function un(r,h){if(r&1){let t=Y();f(0,"div",54)(1,"mat-icon"),C(2,"description"),d(),f(3,"span"),C(4),d(),f(5,"span",55),C(6),d(),f(7,"button",4),k("click",function(){let o=P(t).$index,m=E(4);return W(m.removeAttachment(o))}),f(8,"mat-icon"),C(9,"close"),d()()()}if(r&2){let t=h.$implicit,n=E(4);s(4),M(t.name),s(2),B("(",n.formatFileSize(t.size),")")}}function _n(r,h){if(r&1&&(f(0,"div",53),y(1,un,10,2,"div",54,it),d()),r&2){let t=E(3);s(),b(t.attachments)}}function pn(r,h){if(r&1){let t=Y();f(0,"mat-card",10)(1,"mat-card-header")(2,"mat-card-title"),C(3,"Attachments"),d(),f(4,"mat-card-subtitle"),C(5,"Upload supporting documents"),d()(),f(6,"mat-card-content")(7,"div",50)(8,"input",51,1),k("change",function(o){P(t);let m=E(2);return W(m.onAttachmentSelect(o))}),d(),f(10,"button",52),k("click",function(){P(t);let o=G(9);return W(o.click())}),f(11,"mat-icon"),C(12,"attach_file"),d(),C(13," Add Attachments "),d(),D(14,_n,3,0,"div",53),d()()()}if(r&2){let t=E(2);s(14),v(t.attachments.length>0?14:-1)}}function fn(r,h){r&1&&I(0,"mat-spinner",18)}function En(r,h){r&1&&C(0," Submit for Approval ")}function hn(r,h){if(r&1){let t=Y();f(0,"form",9),k("ngSubmit",function(){P(t);let o=E();return W(o.onSubmit())}),D(1,Gt,5,0,"mat-card",10),y(2,mn,9,4,"mat-card",11,X),D(4,pn,15,1,"mat-card",10),f(5,"mat-card",10)(6,"mat-card-header")(7,"mat-card-title"),C(8,"Additional Comments"),d()(),f(9,"mat-card-content")(10,"mat-form-field",12)(11,"mat-label"),C(12,"Comments"),d(),I(13,"textarea",13),d()()(),f(14,"div",14)(15,"button",15),k("click",function(){P(t);let o=E();return W(o.goBack())}),C(16,"Cancel"),d(),f(17,"button",16),k("click",function(){P(t);let o=E();return W(o.saveDraft())}),C(18," Save Draft "),d(),f(19,"button",17),D(20,fn,1,0,"mat-spinner",18)(21,En,1,0),d()()()}if(r&2){let t=E();A("formGroup",t.form),s(),v(t.getUngroupedFields().length>0?1:-1),s(),b(t.fieldGroups),s(2),v(t.workflow.requireAttachments?4:-1),s(13),A("disabled",t.submitting),s(2),A("disabled",t.submitting),s(),v(t.submitting?20:21)}}var ti=(()=>{class r{fb;workflowService;authService;router;route;snackBar;cdr;workflow=null;form;loading=!0;submitting=!1;workflowCode="";fields=[];fieldGroups=[];selectedFiles={};attachments=[];instanceId=null;isEditMode=!1;existingFieldValues={};calculatedFields=new Map;subscriptions=[];validationErrors={};hasAttemptedSubmit=!1;pendingUniqueChecks=new Map;uniqueCheckCache=new Map;constructor(t,n,o,m,_,T,u){this.fb=t,this.workflowService=n,this.authService=o,this.router=m,this.route=_,this.snackBar=T,this.cdr=u}ngOnInit(){this.workflowCode=this.route.snapshot.paramMap.get("workflowCode")||"",this.instanceId=this.route.snapshot.paramMap.get("instanceId")||null,this.isEditMode=!!this.instanceId,this.loadWorkflow()}ngOnDestroy(){this.subscriptions.forEach(t=>t.unsubscribe())}loadWorkflow(){this.workflowService.getWorkflowByCode(this.workflowCode).subscribe({next:t=>{t.success?(this.workflow=t.data,this.isEditMode&&this.instanceId?this.loadInstance():(this.loading=!1,this.initializeForm())):this.loading=!1},error:()=>{this.loading=!1,this.snackBar.open("Failed to load workflow","Close",{duration:3e3})}})}loadInstance(){this.workflowService.getInstance(this.instanceId).subscribe({next:t=>{this.loading=!1,t.success&&t.data&&(t.data.fieldValues&&(Array.isArray(t.data.fieldValues)?t.data.fieldValues.forEach(n=>{this.existingFieldValues[n.fieldName]=n.value}):this.existingFieldValues=U({},t.data.fieldValues)),this.initializeForm())},error:()=>{this.loading=!1,this.snackBar.open("Failed to load instance","Close",{duration:3e3})}})}initializeForm(){if(!this.workflow?.forms?.[0])return;let t=this.workflow.forms[0],n=t.fieldGroups||[],o=new Map;n.forEach(u=>{u.fields&&Array.isArray(u.fields)&&u.fields.forEach(F=>{let e=F.id?.toString();e&&o.set(e,u.id?.toString())})});let m=new Map;(t.fields||[]).forEach(u=>{let F=u.id?.toString();if(F){let e=u.fieldGroupId?.toString()||o.get(F)||null;m.set(F,V(U({},u),{fieldGroupId:e}))}}),n.forEach(u=>{u.fields&&Array.isArray(u.fields)&&u.fields.forEach(F=>{let e=F.id?.toString();e&&!m.has(e)&&m.set(e,V(U({},F),{fieldGroupId:u.id?.toString()}))})}),this.fields=Array.from(m.values()).map(u=>{let F=(u.type||u.fieldType||"TEXT").toString().toUpperCase();return V(U({},u),{type:F,fieldType:F,required:u.required??u.isMandatory??!1,hidden:u.hidden??u.isHidden??!1,readOnly:u.readOnly??u.isReadonly??!1})}),this.fieldGroups=n;let _=new Set(this.fields.map(u=>u.name)),T={comments:[""]};this.fields.forEach(u=>{let F=[];u.required&&F.push(J.required),u.type==="EMAIL"&&F.push(J.email);let e="";if(this.isEditMode&&this.existingFieldValues[u.name]!==void 0)e=this.existingFieldValues[u.name],u.type==="CHECKBOX"?e=e==="true"||e===!0:u.type==="NUMBER"||u.type==="CURRENCY"?e=Number(e)||null:(u.type==="DATE"||u.type==="DATETIME")&&(e=e?new Date(e):null);else if(u.defaultValue){let c=this.extractFieldDependencies(u.defaultValue,_);c.length>0?(this.calculatedFields.set(u.name,{expression:u.defaultValue,fieldType:u.type,dependencies:c}),e=""):(e=this.evaluateDefaultValue(u.defaultValue,u.type),u.type==="CHECKBOX"?e=e==="true"||e===!0||!1:u.type==="NUMBER"||u.type==="CURRENCY"?e=e?Number(e):null:(u.type==="DATE"||u.type==="DATETIME")&&!(e instanceof Date)&&(e=e?new Date(e):null))}T[u.name]=[e,F]}),this.form=this.fb.group(T),this.setupCalculatedFieldSubscriptions(),this.calculatedFields.forEach((u,F)=>{this.recalculateField(F,u)}),this.setupValidationSubscriptions()}extractFieldDependencies(t,n){let o=[],m=t.match(/^([A-Z_]+)\((.*)\)$/i);if(!m)return o;let _=m[2];return _&&this.parseArgsRaw(_).forEach(u=>{let F=u.trim().replace(/^["']|["']$/g,"");!u.startsWith('"')&&!u.startsWith("'")&&n.has(F)&&o.push(F)}),o}parseArgsRaw(t){let n=[],o="",m=!1,_="";for(let T of t)(T==='"'||T==="'")&&!m?(m=!0,_=T,o+=T):T===_&&m?(m=!1,o+=T,_=""):T===","&&!m?(n.push(o.trim()),o=""):o+=T;return o&&n.push(o.trim()),n}setupCalculatedFieldSubscriptions(){this.calculatedFields.forEach((t,n)=>{let o=t.dependencies.map(m=>this.form.get(m)).filter(m=>m!==null);if(o.length>0){let _=z(...o.map(T=>T.valueChanges)).pipe(H(100)).subscribe(()=>{this.recalculateField(n,t)});this.subscriptions.push(_)}})}setupValidationSubscriptions(){let t=this.form.valueChanges.pipe(H(300)).subscribe(n=>{this.fields.forEach(o=>{if(o.validation&&/Unique\(/i.test(o.validation)){let m=n[o.name],_=[];this.uniqueCheckCache.forEach((T,u)=>{u.startsWith(`${o.name}:`)&&u!==`${o.name}:${m}`&&_.push(u)}),_.forEach(T=>this.uniqueCheckCache.delete(T))}}),this.clearValidationErrors()});this.subscriptions.push(t)}clearValidationErrors(){this.hasAttemptedSubmit=!1,this.fields.forEach(t=>{if(this.validationErrors[t.name]){this.validationErrors[t.name]=null;let o=this.form.get(t.name);if(o&&o.errors){let n=o.errors,{customValidation:m}=n,_=$(n,["customValidation"]);o.setErrors(Object.keys(_).length>0?_:null)}}})}validateAllFields(){this.fields.forEach(t=>{if(t.validation){let o=this.evaluateValidation(t);this.validationErrors[t.name]=o;let m=this.form.get(t.name);if(m){if(o)m.setErrors(V(U({},m.errors),{customValidation:o})),m.markAsTouched();else if(m.errors){let n=m.errors,{customValidation:_}=n,T=$(n,["customValidation"]);m.setErrors(Object.keys(T).length>0?T:null)}}}}),this.cdr.detectChanges()}evaluateValidation(t){let n=t.validation;if(!n)return null;try{let o=n.split(/\s+AND\s+/i);for(let m of o){let _=m.trim(),T=this.evaluateSingleValidation(_,t);if(T)return T}return null}catch{return null}}evaluateSingleValidation(t,n){let o=this.form.get(n.name)?.value,m=n.label||n.name,_=t.match(/^Required\(\s*(?:"([^"]*)"|'([^']*)')?\s*\)$/i);if(_){let e=_[1]||_[2];return o==null||o===""||typeof o=="string"&&o.trim()===""?e||`${m} is required`:null}let T=t.match(/^Unique\(\s*(?:"([^"]*)"|'([^']*)')?\s*\)$/i);if(T){let e=T[1]||T[2];if(o==null||o===""||typeof o=="string"&&o.trim()==="")return null;let c=`${n.name}:${o}`;return this.uniqueCheckCache.has(c)?this.uniqueCheckCache.get(c)?null:e||`${m} value already exists`:(this.pendingUniqueChecks.get(c)||(this.pendingUniqueChecks.set(c,!0),this.checkUniqueField(n.name,String(o),e||`${m} value already exists`)),null)}let u=t.match(/^ValidWhen\(\s*(.+?)(?:\s*,\s*(?:"([^"]*)"|'([^']*)'))?\s*\)$/i);if(u){let e=u[1].trim(),c=u[2]||u[3],g=this.evaluateCondition(e);return g===!0||g==="true"||g===0||g==="0"?null:c||`${m} validation failed`}let F=t.match(/^InvalidWhen\(\s*(.+?)(?:\s*,\s*(?:"([^"]*)"|'([^']*)'))?\s*\)$/i);if(F){let e=F[1].trim(),c=F[2]||F[3],g=this.evaluateCondition(e);return g===!0||g==="true"||typeof g=="number"&&g!==0||typeof g=="string"&&g!=="0"&&g!=="false"&&g!==""?c||`${m} validation failed`:null}return null}evaluateCondition(t){if(/\s+OR\s+/i.test(t)){let m=t.split(/\s+OR\s+/i);for(let _ of m)if(this.evaluateCondition(_.trim()))return!0;return!1}if(/\s+AND\s+/i.test(t)){let m=t.split(/\s+AND\s+/i);for(let _ of m)if(!this.evaluateCondition(_.trim()))return!1;return!0}let n=t.match(/^(.+?)\s*(>=|<=|!=|=|>|<)\s*(.+)$/);if(n){let m=n[1].trim(),_=n[2],T=n[3].trim(),u=this.resolveValue(m),F=this.resolveValue(T);switch(_){case"=":return u==F;case"!=":return u!=F;case">":return Number(u)>Number(F);case"<":return Number(u)<Number(F);case">=":return Number(u)>=Number(F);case"<=":return Number(u)<=Number(F)}}return this.resolveValue(t)}resolveValue(t){let n=t.trim();if(n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'"))return n.slice(1,-1);if(!isNaN(Number(n)))return Number(n);if(n.toLowerCase()==="true")return!0;if(n.toLowerCase()==="false")return!1;if(this.isFunctionExpression(n))return this.evaluateFunction(n,"TEXT");let o=this.form.get(n);return o?o.value:this.containsOperatorsOrFunctions(n)?this.evaluateArithmeticExpression(n):n}containsOperatorsOrFunctions(t){return!!(/[+\-*\/]/.test(t)||/[A-Z_]+\(/i.test(t))}evaluateArithmeticExpression(t){let n=t,o=/\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g,m,_=[];for(;(m=o.exec(t))!==null;){let u=m[1];if(this.isFunctionExpression(u)||["AND","OR","TRUE","FALSE"].includes(u.toUpperCase()))continue;let F=this.form.get(u);F&&_.push({field:u,value:F.value??0})}for(let u of _){let F=typeof u.value=="number"?u.value:parseFloat(u.value)||0;n=n.replace(new RegExp(`\\b${u.field}\\b`,"g"),F.toString())}let T=/([A-Z_]+)\(([^()]*)\)/gi;for(;T.test(n);)n=n.replace(T,u=>this.evaluateFunction(u,"NUMBER").toString());try{return Function('"use strict"; return ('+n+")")()}catch{return n}}checkUniqueField(t,n,o){let m=`${t}:${n}`;this.workflowService.validateUniqueField(this.workflowCode,t,n,this.instanceId||void 0).subscribe({next:_=>{this.pendingUniqueChecks.delete(m);let T=_.data;this.uniqueCheckCache.set(m,T);let u=this.form.get(t);if(!T)this.validationErrors[t]=o,u&&(u.setErrors(V(U({},u.errors),{customValidation:o})),u.markAsTouched());else{let c=this.fields.find(g=>g.name===t);if(c?.validation){let g=this.evaluateNonUniqueValidations(c);if(this.validationErrors[t]=g,u){if(g)u.setErrors(V(U({},u.errors),{customValidation:g})),u.markAsTouched();else if(u.errors){let F=u.errors,{customValidation:l}=F,O=$(F,["customValidation"]);u.setErrors(Object.keys(O).length>0?O:null)}}}else if(this.validationErrors[t]=null,u&&u.errors){let e=u.errors,{customValidation:g}=e,l=$(e,["customValidation"]);u.setErrors(Object.keys(l).length>0?l:null)}}this.cdr.detectChanges()},error:()=>{this.pendingUniqueChecks.delete(m),this.uniqueCheckCache.set(m,!0)}})}evaluateNonUniqueValidations(t){let n=t.validation;if(!n)return null;try{let o=n.split(/\s+AND\s+/i);for(let m of o){let _=m.trim();if(/^Unique\(/i.test(_))continue;let T=this.evaluateSingleValidation(_,t);if(T)return T}return null}catch{return null}}recalculateField(t,n){let o=this.evaluateFunction(n.expression,n.fieldType);n.fieldType==="CHECKBOX"?o=o==="true"||o===!0||!1:n.fieldType==="NUMBER"||n.fieldType==="CURRENCY"?o=o?Number(o):null:(n.fieldType==="DATE"||n.fieldType==="DATETIME")&&!(o instanceof Date)&&(o=o?new Date(o):null);let m=this.form.get(t);m&&m.value!==o&&m.setValue(o,{emitEvent:!1})}getUngroupedFields(){return this.fields.filter(t=>!t.fieldGroupId&&!(t.hidden||t.isHidden))}getFieldsInGroup(t){let n=t?.toString();return this.fields.filter(o=>o.fieldGroupId?.toString()===n&&!(o.hidden||o.isHidden))}isFieldReadonly(t){return t.readOnly||t.isReadonly||!1}isFieldRequired(t){return t.required?!0:t.validation?/Required\s*\(/i.test(t.validation):!1}hasFieldError(t){if(!this.hasAttemptedSubmit)return!1;let n=this.form.get(t.name),o=n?.invalid,m=!!this.validationErrors[t.name],_=n?.hasError("customValidation");return o||m||!!_}getFieldErrorMessage(t){let n=this.form.get(t.name);return this.validationErrors[t.name]?this.validationErrors[t.name]:n?.hasError("customValidation")?n.getError("customValidation"):n?.hasError("required")?`${t.label} is required`:n?.hasError("email")?"Please enter a valid email":null}getErrorStateMatcher(t){let n=this.validationErrors;return{isErrorState:o=>{if(!o)return!1;let m=!!n[t.name],_=o.invalid&&(o.touched||o.dirty);return m||_}}}evaluateDefaultValue(t,n){if(!t)return"";let o=t.trim();return this.isFunctionExpression(o)?this.evaluateFunction(o,n):t}isFunctionExpression(t){let n=/^[A-Z_]+\(.*\)$/i,o=["TODAY","NOW","CURRENT_USER","CURRENT_USER_EMAIL","CURRENT_USER_ID","CURRENT_USERNAME","CURRENT_USER_PHONE","CURRENT_USER_DEPARTMENT","CURRENT_USER_STAFFID","CURRENT_USER_ROLE","CURRENT_USER_SBU","CURRENT_USER_BRANCH","CURRENT_DATE","CURRENT_TIME","CURRENT_DATETIME","CURRENT_YEAR","CURRENT_MONTH","UUID","SHORT_UUID","TIMESTAMP","PI","E","RANDOM","WORKFLOW_ID","WORKFLOW_NAME","INSTANCE_ID","INSTANCE_STATUS","SUBMISSION_DATE","SUBMITTER_NAME","SUBMITTER_EMAIL","APPROVAL_LEVEL","APPROVER_NAME","ENVIRONMENT","VERSION","LOCALE","TIMEZONE","BROWSER","PLATFORM","IS_MOBILE","SCREEN_WIDTH","SCREEN_HEIGHT"];return n.test(t)||o.includes(t.toUpperCase())}evaluateFunction(t,n){let o=this.authService.currentUser,m=t.toUpperCase().trim(),_=(n||"").toUpperCase(),T=t.match(/^([A-Z_]+)\((.*)\)$/i),u=T?T[1].toUpperCase():m,F=T?T[2]:"",e=F?this.parseArgs(F):[],c=R=>parseFloat(R)||0,g=R=>parseInt(R)||0,l=R=>String(R??""),O=R=>R===!0||R==="true"||R==="1"||R===1,S=R=>R instanceof Date?R:new Date(R);switch(u){case"UPPER":return l(e[0]).toUpperCase();case"LOWER":return l(e[0]).toLowerCase();case"TRIM":return l(e[0]).trim();case"TRIM_LEFT":return l(e[0]).trimStart();case"TRIM_RIGHT":return l(e[0]).trimEnd();case"CONCAT":return e.join("");case"LEFT":return l(e[0]).substring(0,g(e[1]));case"RIGHT":{let i=l(e[0]);return i.substring(i.length-g(e[1]))}case"SUBSTRING":return l(e[0]).substring(g(e[1]),g(e[1])+g(e[2]));case"LENGTH":return l(e[0]).length.toString();case"REPLACE":return l(e[0]).split(l(e[1])).join(l(e[2]));case"REPLACE_FIRST":return l(e[0]).replace(l(e[1]),l(e[2]));case"CONTAINS":return l(e[0]).includes(l(e[1])).toString();case"CONTAINS_IGNORE_CASE":return l(e[0]).toLowerCase().includes(l(e[1]).toLowerCase()).toString();case"STARTS_WITH":return l(e[0]).startsWith(l(e[1])).toString();case"ENDS_WITH":return l(e[0]).endsWith(l(e[1])).toString();case"CAPITALIZE":return l(e[0]).charAt(0).toUpperCase()+l(e[0]).slice(1).toLowerCase();case"TITLE_CASE":return l(e[0]).replace(/\b\w/g,i=>i.toUpperCase());case"SENTENCE_CASE":return l(e[0]).replace(/(^\s*\w|[.!?]\s*\w)/g,i=>i.toUpperCase());case"REVERSE":return l(e[0]).split("").reverse().join("");case"REPEAT":return l(e[0]).repeat(g(e[1]));case"PAD_LEFT":return l(e[0]).padStart(g(e[1]),l(e[2])||" ");case"PAD_RIGHT":return l(e[0]).padEnd(g(e[1]),l(e[2])||" ");case"WORD_COUNT":return l(e[0]).trim().split(/\s+/).filter(i=>i).length.toString();case"CHAR_AT":return l(e[0]).charAt(g(e[1]));case"INDEX_OF":return l(e[0]).indexOf(l(e[1])).toString();case"LAST_INDEX_OF":return l(e[0]).lastIndexOf(l(e[1])).toString();case"SPLIT":return JSON.stringify(l(e[0]).split(l(e[1])));case"JOIN":try{return JSON.parse(l(e[0])).join(l(e[1]))}catch{return e[0]}case"INITIALS":return l(e[0]).split(/\s+/).map(i=>i.charAt(0).toUpperCase()).join("");case"SLUG":return l(e[0]).toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");case"CLEAN":return l(e[0]).replace(/[^\x20-\x7E]/g,"");case"REMOVE_SPACES":return l(e[0]).replace(/\s/g,"");case"COLLAPSE_SPACES":return l(e[0]).replace(/\s+/g," ");case"EXTRACT_NUMBERS":return l(e[0]).replace(/[^0-9]/g,"");case"EXTRACT_LETTERS":return l(e[0]).replace(/[^a-zA-Z]/g,"");case"EXTRACT_ALPHANUMERIC":return l(e[0]).replace(/[^a-zA-Z0-9]/g,"");case"MASK":{let i=l(e[0]),a=g(e[1]),p=g(e[2]),x=l(e[3])||"*",N=p<0?i.length+p:p;return i.substring(0,a)+x.repeat(N-a)+i.substring(N)}case"MASK_EMAIL":{let i=l(e[0]),[a,p]=i.split("@");return p?a.charAt(0)+"***@"+p:i}case"MASK_PHONE":{let i=l(e[0]).replace(/\D/g,"");return i.length>4?"*".repeat(i.length-4)+i.slice(-4):i}case"FORMAT_PHONE":{let i=l(e[0]).replace(/\D/g,""),a=l(e[1]).toUpperCase();return a==="US"&&i.length===10?`(${i.slice(0,3)}) ${i.slice(3,6)}-${i.slice(6)}`:a==="INTL"&&i.length>=10?`+${i.slice(0,-10)} ${i.slice(-10,-7)} ${i.slice(-7,-4)} ${i.slice(-4)}`:i}case"ENCODE_HTML":return l(e[0]).replace(/[&<>"']/g,i=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[i]||i);case"DECODE_HTML":return l(e[0]).replace(/&amp;|&lt;|&gt;|&quot;|&#39;/g,i=>({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"})[i]||i);case"WRAP":return l(e[1])+l(e[0])+l(e[2]);case"TRUNCATE":{let i=l(e[0]),a=g(e[1]),p=l(e[2])||"...";return i.length>a?i.substring(0,a-p.length)+p:i}case"REGEX_MATCH":try{return new RegExp(l(e[1])).test(l(e[0])).toString()}catch{return"false"}case"REGEX_EXTRACT":try{let i=l(e[0]).match(new RegExp(l(e[1])));return i?i[0]:""}catch{return""}case"REGEX_REPLACE":try{return l(e[0]).replace(new RegExp(l(e[1]),"g"),l(e[2]))}catch{return e[0]}case"SUM":return e.reduce((i,a)=>i+c(a),0).toString();case"SUBTRACT":return(c(e[0])-c(e[1])).toString();case"MULTIPLY":return(c(e[0])*c(e[1])).toString();case"DIVIDE":return c(e[1])===0?"0":(c(e[0])/c(e[1])).toString();case"ROUND":return c(e[0]).toFixed(g(e[1]));case"ROUND_UP":let R=Math.pow(10,g(e[1]));return(Math.ceil(c(e[0])*R)/R).toString();case"ROUND_DOWN":let K=Math.pow(10,g(e[1]));return(Math.floor(c(e[0])*K)/K).toString();case"FLOOR":return Math.floor(c(e[0])).toString();case"CEIL":return Math.ceil(c(e[0])).toString();case"TRUNC":return Math.trunc(c(e[0])).toString();case"ABS":return Math.abs(c(e[0])).toString();case"SIGN":return Math.sign(c(e[0])).toString();case"NEGATE":return(-c(e[0])).toString();case"MIN":return Math.min(...e.map(c)).toString();case"MAX":return Math.max(...e.map(c)).toString();case"AVERAGE":{let i=e.map(c);return(i.reduce((a,p)=>a+p,0)/i.length).toString()}case"MEDIAN":{let i=e.map(c).sort((p,x)=>p-x),a=Math.floor(i.length/2);return(i.length%2?i[a]:(i[a-1]+i[a])/2).toString()}case"MODE":{let i={};return e.forEach(a=>{i[a]=(i[a]||0)+1}),Object.entries(i).sort((a,p)=>p[1]-a[1])[0]?.[0]||""}case"COUNT":return e.filter(i=>i!==""&&i!==null&&i!==void 0).length.toString();case"PRODUCT":return e.reduce((i,a)=>i*c(a),1).toString();case"PERCENTAGE":return c(e[1])===0?"0":(c(e[0])/c(e[1])*100).toString();case"PERCENT_OF":return(c(e[0])*c(e[1])/100).toString();case"PERCENT_CHANGE":return c(e[0])===0?"0":((c(e[1])-c(e[0]))/c(e[0])*100).toString();case"MOD":return(c(e[0])%c(e[1])).toString();case"POWER":return Math.pow(c(e[0]),c(e[1])).toString();case"SQRT":return Math.sqrt(c(e[0])).toString();case"CBRT":return Math.cbrt(c(e[0])).toString();case"LOG":return Math.log(c(e[0])).toString();case"LOG10":return Math.log10(c(e[0])).toString();case"LOG2":return Math.log2(c(e[0])).toString();case"EXP":return Math.exp(c(e[0])).toString();case"FACTORIAL":{let i=g(e[0]),a=1;for(let p=2;p<=i;p++)a*=p;return a.toString()}case"GCD":{let i=Math.abs(g(e[0])),a=Math.abs(g(e[1]));for(;a;)[i,a]=[a,i%a];return i.toString()}case"LCM":{let i=Math.abs(g(e[0])),a=Math.abs(g(e[1])),p=i,x=a;for(;x;)[p,x]=[x,p%x];return(i*a/p).toString()}case"RANDOM":return Math.random().toString();case"RANDOM_INT":return(Math.floor(Math.random()*(g(e[1])-g(e[0])+1))+g(e[0])).toString();case"CLAMP":return Math.min(Math.max(c(e[0]),c(e[1])),c(e[2])).toString();case"INTERPOLATE":return(c(e[0])+(c(e[1])-c(e[0]))*c(e[2])).toString();case"MAP_RANGE":{let i=c(e[0]),a=c(e[1]),p=c(e[2]),x=c(e[3]),N=c(e[4]);return((i-a)/(p-a)*(N-x)+x).toString()}case"SIN":return Math.sin(c(e[0])).toString();case"COS":return Math.cos(c(e[0])).toString();case"TAN":return Math.tan(c(e[0])).toString();case"DEGREES":return(c(e[0])*180/Math.PI).toString();case"RADIANS":return(c(e[0])*Math.PI/180).toString();case"PI":return Math.PI.toString();case"E":return Math.E.toString();case"VARIANCE":{let i=e.map(c),a=i.reduce((p,x)=>p+x,0)/i.length;return(i.reduce((p,x)=>p+Math.pow(x-a,2),0)/i.length).toString()}case"STDEV":{let i=e.map(c),a=i.reduce((p,x)=>p+x,0)/i.length;return Math.sqrt(i.reduce((p,x)=>p+Math.pow(x-a,2),0)/i.length).toString()}case"RANGE":{let i=e.map(c);return(Math.max(...i)-Math.min(...i)).toString()}case"COMPOUND_INTEREST":return(c(e[0])*Math.pow(1+c(e[1]),c(e[2]))).toString();case"SIMPLE_INTEREST":return(c(e[0])*(1+c(e[1])*c(e[2]))).toString();case"PMT":{let i=c(e[0]),a=c(e[1]),p=c(e[2]);return i===0?(p/a).toString():(p*i/(1-Math.pow(1+i,-a))).toString()}case"FV":return(c(e[2])*((Math.pow(1+c(e[0]),c(e[1]))-1)/c(e[0]))).toString();case"PV":return(c(e[2])*((1-Math.pow(1+c(e[0]),-c(e[1])))/c(e[0]))).toString();case"FORMAT_NUMBER":{let i=c(e[0]),a=g(e[1]);return i.toLocaleString("en-US",{minimumFractionDigits:a,maximumFractionDigits:a})}case"FORMAT_PERCENTAGE":return c(e[0]).toFixed(g(e[1]))+"%";case"FORMAT_BYTES":{let i=c(e[0]);if(i===0)return"0 Bytes";let a=1024,p=["Bytes","KB","MB","GB","TB"],x=Math.floor(Math.log(i)/Math.log(a));return(i/Math.pow(a,x)).toFixed(2)+" "+p[x]}case"FORMAT_ORDINAL":{let i=g(e[0]),a=["th","st","nd","rd"],p=i%100;return i+(a[(p-20)%10]||a[p]||a[0])}case"ROMAN":{let i=g(e[0]),a="",p=[[1e3,"M"],[900,"CM"],[500,"D"],[400,"CD"],[100,"C"],[90,"XC"],[50,"L"],[40,"XL"],[10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]];for(let[x,N]of p)for(;i>=x;)a+=N,i-=x;return a}case"HEX":return g(e[0]).toString(16).toUpperCase();case"BIN":return g(e[0]).toString(2);case"OCT":return g(e[0]).toString(8);case"PARSE_INT":return parseInt(l(e[0]),g(e[1])||10).toString();case"TODAY":return _==="DATE"||_==="DATETIME"?new Date:this.formatDate(new Date);case"NOW":return _==="DATETIME"?new Date:this.formatDateTime(new Date);case"TIMESTAMP":return Date.now().toString();case"DATE":{let i=new Date(g(e[0]),g(e[1])-1,g(e[2]));return _==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"DATETIME":{let i=new Date(g(e[0]),g(e[1])-1,g(e[2]),g(e[3]),g(e[4]),g(e[5]));return _==="DATETIME"?i:this.formatDateTime(i)}case"DATE_FORMAT":{let i=S(e[0]),a=l(e[1]);return this.formatDateWithPattern(i,a)}case"DATE_PARSE":return new Date(l(e[0])).toISOString();case"DATE_ADD":{let i=S(e[0]),a=g(e[1]),p=l(e[2]).toLowerCase();return this.addToDate(i,a,p)}case"DATE_SUBTRACT":{let i=S(e[0]),a=g(e[1]),p=l(e[2]).toLowerCase();return this.addToDate(i,-a,p)}case"DATE_DIFF":{let i=S(e[0]),a=S(e[1]),p=l(e[2]).toLowerCase();return this.dateDiff(i,a,p)}case"AGE":{let i=S(e[0]),a=new Date,p=a.getFullYear()-i.getFullYear();return(a.getMonth()<i.getMonth()||a.getMonth()===i.getMonth()&&a.getDate()<i.getDate())&&p--,p.toString()}case"AGE_DETAILED":{let i=S(e[0]),a=new Date,p=a.getFullYear()-i.getFullYear(),x=a.getMonth()-i.getMonth(),N=a.getDate()-i.getDate();return N<0&&(x--,N+=new Date(a.getFullYear(),a.getMonth(),0).getDate()),x<0&&(p--,x+=12),`${p} years, ${x} months, ${N} days`}case"YEAR":return e[0]?S(e[0]).getFullYear().toString():new Date().getFullYear().toString();case"MONTH":return e[0]?(S(e[0]).getMonth()+1).toString():(new Date().getMonth()+1).toString();case"DAY":return e[0]?S(e[0]).getDate().toString():new Date().getDate().toString();case"HOUR":return e[0]?S(e[0]).getHours().toString():new Date().getHours().toString();case"MINUTE":return e[0]?S(e[0]).getMinutes().toString():new Date().getMinutes().toString();case"SECOND":return e[0]?S(e[0]).getSeconds().toString():new Date().getSeconds().toString();case"MILLISECOND":return e[0]?S(e[0]).getMilliseconds().toString():new Date().getMilliseconds().toString();case"WEEKDAY":return((e[0]?S(e[0]):new Date).getDay()||7).toString();case"WEEKDAY_NAME":{let i=e[0]?S(e[0]):new Date;return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][i.getDay()]}case"WEEKDAY_SHORT":{let i=e[0]?S(e[0]):new Date;return["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][i.getDay()]}case"WEEK_NUMBER":{let i=e[0]?S(e[0]):new Date,a=new Date(i.getFullYear(),0,1);return Math.ceil(((i.getTime()-a.getTime())/864e5+a.getDay()+1)/7).toString()}case"QUARTER":{let i=e[0]?S(e[0]):new Date;return(Math.floor(i.getMonth()/3)+1).toString()}case"MONTH_NAME":{let i=e[0]?S(e[0]):new Date;return["January","February","March","April","May","June","July","August","September","October","November","December"][i.getMonth()]}case"MONTH_SHORT":{let i=e[0]?S(e[0]):new Date;return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][i.getMonth()]}case"DAY_OF_YEAR":{let i=e[0]?S(e[0]):new Date,a=new Date(i.getFullYear(),0,0);return Math.floor((i.getTime()-a.getTime())/864e5).toString()}case"DAYS_IN_MONTH":{let i=e[0]?S(e[0]):new Date;return new Date(i.getFullYear(),i.getMonth()+1,0).getDate().toString()}case"DAYS_IN_YEAR":{let a=(e[0]?S(e[0]):new Date).getFullYear();return(a%4===0&&a%100!==0||a%400===0?366:365).toString()}case"IS_LEAP_YEAR":{let i=e[0]?S(e[0]).getFullYear():new Date().getFullYear();return(i%4===0&&i%100!==0||i%400===0).toString()}case"START_OF_DAY":{let i=new Date(e[0]?S(e[0]):new Date);return i.setHours(0,0,0,0),_==="DATETIME"?i:this.formatDateTime(i)}case"END_OF_DAY":{let i=new Date(e[0]?S(e[0]):new Date);return i.setHours(23,59,59,999),_==="DATETIME"?i:this.formatDateTime(i)}case"START_OF_WEEK":{let i=new Date(e[0]?S(e[0]):new Date),a=i.getDay()||7;return i.setDate(i.getDate()-a+1),_==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"END_OF_WEEK":{let i=new Date(e[0]?S(e[0]):new Date),a=i.getDay()||7;return i.setDate(i.getDate()+(7-a)),_==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"START_OF_MONTH":{let i=new Date(e[0]?S(e[0]):new Date);return i.setDate(1),_==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"END_OF_MONTH":{let i=new Date(e[0]?S(e[0]):new Date);return i.setMonth(i.getMonth()+1,0),_==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"START_OF_QUARTER":{let i=new Date(e[0]?S(e[0]):new Date);return i.setMonth(Math.floor(i.getMonth()/3)*3,1),_==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"END_OF_QUARTER":{let i=new Date(e[0]?S(e[0]):new Date);return i.setMonth(Math.floor(i.getMonth()/3)*3+3,0),_==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"START_OF_YEAR":{let i=new Date(e[0]?S(e[0]):new Date);return i.setMonth(0,1),_==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"END_OF_YEAR":{let i=new Date(e[0]?S(e[0]):new Date);return i.setMonth(11,31),_==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"IS_WEEKEND":{let i=(e[0]?S(e[0]):new Date).getDay();return(i===0||i===6).toString()}case"IS_WEEKDAY":{let i=(e[0]?S(e[0]):new Date).getDay();return(i!==0&&i!==6).toString()}case"IS_TODAY":{let i=e[0]?S(e[0]):new Date,a=new Date;return(i.toDateString()===a.toDateString()).toString()}case"IS_YESTERDAY":{let i=e[0]?S(e[0]):new Date,a=new Date;return a.setDate(a.getDate()-1),(i.toDateString()===a.toDateString()).toString()}case"IS_TOMORROW":{let i=e[0]?S(e[0]):new Date,a=new Date;return a.setDate(a.getDate()+1),(i.toDateString()===a.toDateString()).toString()}case"IS_PAST":return((e[0]?S(e[0]):new Date)<new Date).toString();case"IS_FUTURE":return((e[0]?S(e[0]):new Date)>new Date).toString();case"IS_THIS_WEEK":{let i=e[0]?S(e[0]):new Date,a=new Date,p=new Date(a);p.setDate(a.getDate()-(a.getDay()||7)+1);let x=new Date(p);return x.setDate(p.getDate()+6),(i>=p&&i<=x).toString()}case"IS_THIS_MONTH":{let i=e[0]?S(e[0]):new Date,a=new Date;return(i.getMonth()===a.getMonth()&&i.getFullYear()===a.getFullYear()).toString()}case"IS_THIS_YEAR":return((e[0]?S(e[0]):new Date).getFullYear()===new Date().getFullYear()).toString();case"IS_SAME_DAY":return(S(e[0]).toDateString()===S(e[1]).toDateString()).toString();case"IS_BEFORE":return(S(e[0])<S(e[1])).toString();case"IS_AFTER":return(S(e[0])>S(e[1])).toString();case"IS_BETWEEN_DATES":{let i=S(e[0]),a=S(e[1]),p=S(e[2]);return(i>=a&&i<=p).toString()}case"BUSINESS_DAYS":{let i=S(e[0]),a=S(e[1]),p=0,x=new Date(i);for(;x<=a;){let N=x.getDay();N!==0&&N!==6&&p++,x.setDate(x.getDate()+1)}return p.toString()}case"ADD_BUSINESS_DAYS":{let i=new Date(e[0]?S(e[0]):new Date),a=g(e[1]);for(;a>0;)i.setDate(i.getDate()+1),i.getDay()!==0&&i.getDay()!==6&&a--;return _==="DATE"||_==="DATETIME"?i:this.formatDate(i)}case"RELATIVE_TIME":{let i=e[0]?S(e[0]):new Date,a=Date.now()-i.getTime(),p=Math.abs(a),x=a<0;return p<6e4?x?"in a few seconds":"just now":p<36e5?`${x?"in ":""}${Math.floor(p/6e4)} minutes${x?"":" ago"}`:p<864e5?`${x?"in ":""}${Math.floor(p/36e5)} hours${x?"":" ago"}`:`${x?"in ":""}${Math.floor(p/864e5)} days${x?"":" ago"}`}case"ISO_STRING":return(e[0]?S(e[0]):new Date).toISOString();case"CURRENT_DATE":return this.formatDate(new Date);case"CURRENT_TIME":return new Date().toTimeString().split(" ")[0];case"CURRENT_DATETIME":return this.formatDateTime(new Date);case"CURRENT_YEAR":return new Date().getFullYear().toString();case"CURRENT_MONTH":return(new Date().getMonth()+1).toString();case"IF":return this.evaluateCondition(e[0])?e[1]:e[2];case"IFS":{for(let i=0;i<e.length-1;i+=2)if(this.evaluateCondition(e[i]))return e[i+1];return e.length%2===1?e[e.length-1]:""}case"SWITCH":{let i=e[0];for(let a=1;a<e.length-1;a+=2)if(i===e[a])return e[a+1];return e.length%2===0?e[e.length-1]:""}case"AND":return e.every(i=>O(i)||this.evaluateCondition(i)).toString();case"OR":return e.some(i=>O(i)||this.evaluateCondition(i)).toString();case"NOT":return(!O(e[0])).toString();case"XOR":return(O(e[0])!==O(e[1])).toString();case"NAND":return(!(O(e[0])&&O(e[1]))).toString();case"NOR":return(!(O(e[0])||O(e[1]))).toString();case"IS_EMPTY":return(!e[0]||l(e[0]).trim()==="").toString();case"IS_NOT_EMPTY":return(e[0]&&l(e[0]).trim()!=="").toString();case"IS_NULL":return(e[0]===null||e[0]===void 0||e[0]==="").toString();case"IS_NOT_NULL":return(e[0]!==null&&e[0]!==void 0&&e[0]!=="").toString();case"IS_BLANK":return(!e[0]||l(e[0]).trim()==="").toString();case"IS_TRUE":return O(e[0]).toString();case"IS_FALSE":return(!O(e[0])).toString();case"EQUALS":return(e[0]===e[1]).toString();case"EQUALS_IGNORE_CASE":return(l(e[0]).toLowerCase()===l(e[1]).toLowerCase()).toString();case"NOT_EQUALS":return(e[0]!==e[1]).toString();case"GREATER_THAN":return(c(e[0])>c(e[1])).toString();case"GREATER_THAN_OR_EQUAL":return(c(e[0])>=c(e[1])).toString();case"LESS_THAN":return(c(e[0])<c(e[1])).toString();case"LESS_THAN_OR_EQUAL":return(c(e[0])<=c(e[1])).toString();case"BETWEEN":return(c(e[0])>=c(e[1])&&c(e[0])<=c(e[2])).toString();case"NOT_BETWEEN":return(c(e[0])<c(e[1])||c(e[0])>c(e[2])).toString();case"IN":try{return JSON.parse(e[1]).includes(e[0]).toString()}catch{return"false"}case"NOT_IN":try{return(!JSON.parse(e[1]).includes(e[0])).toString()}catch{return"true"}case"IS_NUMBER":return(!isNaN(parseFloat(e[0]))&&isFinite(c(e[0]))).toString();case"IS_INTEGER":return Number.isInteger(c(e[0])).toString();case"IS_DECIMAL":return(c(e[0])%1!==0).toString();case"IS_POSITIVE":return(c(e[0])>0).toString();case"IS_NEGATIVE":return(c(e[0])<0).toString();case"IS_ZERO":return(c(e[0])===0).toString();case"IS_EVEN":return(g(e[0])%2===0).toString();case"IS_ODD":return(g(e[0])%2!==0).toString();case"IS_TEXT":return(typeof e[0]=="string").toString();case"IS_DATE":return(!isNaN(new Date(e[0]).getTime())).toString();case"IS_BOOLEAN":return(e[0]==="true"||e[0]==="false"||typeof e[0]=="boolean").toString();case"IS_EMAIL":return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l(e[0])).toString();case"IS_URL":try{return new URL(l(e[0])),"true"}catch{return"false"}case"IS_PHONE":return/^[\d\s\-\+\(\)]{7,20}$/.test(l(e[0])).toString();case"IS_UUID":return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(l(e[0])).toString();case"IS_ALPHANUMERIC":return/^[a-zA-Z0-9]+$/.test(l(e[0])).toString();case"IS_ALPHA":return/^[a-zA-Z]+$/.test(l(e[0])).toString();case"IS_NUMERIC":return/^[0-9]+$/.test(l(e[0])).toString();case"IS_UPPERCASE":return(l(e[0])===l(e[0]).toUpperCase()).toString();case"IS_LOWERCASE":return(l(e[0])===l(e[0]).toLowerCase()).toString();case"MATCHES_PATTERN":try{return new RegExp(l(e[1])).test(l(e[0])).toString()}catch{return"false"}case"HAS_LENGTH":return(l(e[0]).length===g(e[1])).toString();case"HAS_MIN_LENGTH":return(l(e[0]).length>=g(e[1])).toString();case"HAS_MAX_LENGTH":return(l(e[0]).length<=g(e[1])).toString();case"CURRENT_USER":return o?.fullName||"";case"CURRENT_USER_EMAIL":return o?.email||"";case"CURRENT_USER_ID":return o?.userId||"";case"CURRENT_USERNAME":return o?.username||"";case"CURRENT_USER_PHONE":return o?.phoneNumber||"";case"CURRENT_USER_DEPARTMENT":return o?.department||"";case"CURRENT_USER_STAFFID":return o?.staffId||"";case"CURRENT_USER_ROLE":return o?.userType||"";case"CURRENT_USER_SBU":return o?.sbuIds?.[0]||"";case"CURRENT_USER_BRANCH":return o?.branchIds?.[0]||"";case"UUID":return this.generateUUID();case"SHORT_UUID":return this.generateUUID().substring(0,8);case"NANO_ID":{let i=g(e[0])||21,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",p="";for(let x=0;x<i;x++)p+=a.charAt(Math.floor(Math.random()*a.length));return p}case"SEQUENCE":return l(e[0])+Date.now().toString().slice(-8);case"SEQUENCE_PADDED":{let i=l(e[0]),a=g(e[1])||6;return i+Date.now().toString().slice(-a).padStart(a,"0")}case"RANDOM_STRING":{let i=g(e[0])||10,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",p="";for(let x=0;x<i;x++)p+=a.charAt(Math.floor(Math.random()*a.length));return p}case"RANDOM_CODE":{let i=g(e[0])||6,a=l(e[1]).toUpperCase(),p="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";a==="ALPHA"?p="ABCDEFGHIJKLMNOPQRSTUVWXYZ":a==="NUMERIC"&&(p="0123456789");let x="";for(let N=0;N<i;N++)x+=p.charAt(Math.floor(Math.random()*p.length));return x}case"COALESCE":case"DEFAULT":return e.find(i=>i&&l(i).trim()!=="")||"";case"NULLIF":return e[0]===e[1]?"":e[0];case"NVL":case"IFNULL":return e[0]===null||e[0]===void 0||e[0]===""?e[1]:e[0];case"FORMAT_CURRENCY":{let i=c(e[0]),a=l(e[1])||"USD";try{return new Intl.NumberFormat("en-US",{style:"currency",currency:a}).format(i)}catch{return i.toFixed(2)}}case"TO_NUMBER":return c(e[0]).toString();case"TO_TEXT":return l(e[0]);case"TO_BOOLEAN":return O(e[0]).toString();case"TO_DATE":return this.formatDate(S(e[0]));case"TO_ARRAY":return JSON.stringify(l(e[0]).split(",").map(i=>i.trim()));case"TO_JSON":try{return JSON.stringify(e[0])}catch{return""}case"FROM_JSON":try{return JSON.parse(l(e[0]))}catch{return e[0]}case"FIELD_VALUE":{let i=l(e[0]);return this.getFieldValue(i)||""}case"FIELD_LABEL":{let i=l(e[0]);return this.fields.find(p=>p.name===i)?.label||i}case"GET":try{let i=l(e[1]).split("."),a=JSON.parse(l(e[0]));for(let p of i)a=a?.[p];return a??e[2]??""}catch{return e[2]??""}case"KEYS":try{return JSON.stringify(Object.keys(JSON.parse(l(e[0]))))}catch{return"[]"}case"VALUES":try{return JSON.stringify(Object.values(JSON.parse(l(e[0]))))}catch{return"[]"}case"ARRAY_LENGTH":try{return JSON.parse(l(e[0])).length.toString()}catch{return"0"}case"ARRAY_FIRST":try{return JSON.parse(l(e[0]))[0]??""}catch{return""}case"ARRAY_LAST":try{let i=JSON.parse(l(e[0]));return i[i.length-1]??""}catch{return""}case"ARRAY_JOIN":try{return JSON.parse(l(e[0])).join(l(e[1]))}catch{return""}case"ARRAY_SUM":try{return JSON.parse(l(e[0])).reduce((i,a)=>i+c(a),0).toString()}catch{return"0"}case"ARRAY_AVERAGE":try{let i=JSON.parse(l(e[0]));return(i.reduce((a,p)=>a+c(p),0)/i.length).toString()}catch{return"0"}case"ARRAY_MIN":try{return Math.min(...JSON.parse(l(e[0])).map(c)).toString()}catch{return"0"}case"ARRAY_MAX":try{return Math.max(...JSON.parse(l(e[0])).map(c)).toString()}catch{return"0"}case"ARRAY_UNIQUE":try{return JSON.stringify([...new Set(JSON.parse(l(e[0])))])}catch{return"[]"}case"ARRAY_REVERSE":try{return JSON.stringify(JSON.parse(l(e[0])).reverse())}catch{return"[]"}case"ARRAY_SORT":try{let i=JSON.parse(l(e[0])),a=l(e[1]).toUpperCase();return JSON.stringify(i.sort((p,x)=>a==="DESC"?x>p?1:-1:p>x?1:-1))}catch{return"[]"}case"ARRAY_INCLUDES":try{return JSON.parse(l(e[0])).includes(e[1]).toString()}catch{return"false"}case"ARRAY_INDEX_OF":try{return JSON.parse(l(e[0])).indexOf(e[1]).toString()}catch{return"-1"}case"TEMPLATE":{let i=l(e[0]);try{let a=typeof e[1]=="object"?e[1]:JSON.parse(l(e[1]));return i.replace(/\{\{(\w+)\}\}/g,(p,x)=>a[x]??"")}catch{return i}}case"BASE64_ENCODE":try{return btoa(l(e[0]))}catch{return""}case"BASE64_DECODE":try{return atob(l(e[0]))}catch{return""}case"URL_ENCODE":return encodeURIComponent(l(e[0]));case"URL_DECODE":return decodeURIComponent(l(e[0]));case"TRY":try{return this.evaluateFunction(l(e[0]),n)}catch{return e[1]||""}case"TYPEOF":return typeof e[0];case"CLONE":try{return JSON.stringify(JSON.parse(JSON.stringify(e[0])))}catch{return e[0]}case"COMPARE":return e[0]>e[1]?"1":e[0]<e[1]?"-1":"0";case"EQUALS_DEEP":try{return(JSON.stringify(e[0])===JSON.stringify(e[1])).toString()}catch{return"false"}case"WORKFLOW_ID":return this.workflow?.id||"";case"WORKFLOW_NAME":return this.workflow?.name||"";case"INSTANCE_ID":return this.instanceId||"";case"ENVIRONMENT":return"PROD";case"VERSION":return"1.0.0";case"LOCALE":return navigator.language||"en-US";case"TIMEZONE":return Intl.DateTimeFormat().resolvedOptions().timeZone;case"BROWSER":return navigator.userAgent.includes("Chrome")?"Chrome":navigator.userAgent.includes("Firefox")?"Firefox":navigator.userAgent.includes("Safari")?"Safari":"Unknown";case"PLATFORM":return navigator.platform||"Unknown";case"IS_MOBILE":return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent).toString();case"SCREEN_WIDTH":return window.screen.width.toString();case"SCREEN_HEIGHT":return window.screen.height.toString();default:return t}}formatDateWithPattern(t,n){if(!t||isNaN(t.getTime()))return"";let o=T=>T.toString().padStart(2,"0"),m={YYYY:t.getFullYear().toString(),YY:t.getFullYear().toString().slice(-2),MMMM:["January","February","March","April","May","June","July","August","September","October","November","December"][t.getMonth()],MMM:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()],MM:o(t.getMonth()+1),DD:o(t.getDate()),ddd:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][t.getDay()],HH:o(t.getHours()),mm:o(t.getMinutes()),ss:o(t.getSeconds())},_=n;for(let[T,u]of Object.entries(m))_=_.replace(new RegExp(T,"g"),u);return _}addToDate(t,n,o){let m=new Date(t);switch(o){case"years":m.setFullYear(m.getFullYear()+n);break;case"months":m.setMonth(m.getMonth()+n);break;case"weeks":m.setDate(m.getDate()+n*7);break;case"days":m.setDate(m.getDate()+n);break;case"hours":m.setHours(m.getHours()+n);break;case"minutes":m.setMinutes(m.getMinutes()+n);break;case"seconds":m.setSeconds(m.getSeconds()+n);break}return this.formatDate(m)}dateDiff(t,n,o){let m=Math.abs(n.getTime()-t.getTime());switch(o){case"years":return Math.floor(m/(365.25*24*60*60*1e3)).toString();case"months":return Math.floor(m/(30.44*24*60*60*1e3)).toString();case"weeks":return Math.floor(m/(7*24*60*60*1e3)).toString();case"days":return Math.floor(m/(24*60*60*1e3)).toString();case"hours":return Math.floor(m/(60*60*1e3)).toString();case"minutes":return Math.floor(m/(60*1e3)).toString();case"seconds":return Math.floor(m/1e3).toString();default:return Math.floor(m/(24*60*60*1e3)).toString()}}parseStringArg(t,n=!0){let o=t.replace(/^["']|["']$/g,"").trim();if(n&&!t.startsWith('"')&&!t.startsWith("'")){let m=this.getFieldValue(o);if(m!==null)return String(m)}return o}parseArgs(t,n=!0){let o=[],m="",_=!1,T="";for(let u of t)(u==='"'||u==="'")&&!_?(_=!0,T=u,m+=u):u===T&&_?(_=!1,m+=u,T=""):u===","&&!_?(o.push(this.resolveArgValue(m.trim(),n)),m=""):m+=u;return m&&o.push(this.resolveArgValue(m.trim(),n)),o}resolveArgValue(t,n){if(t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))return t.slice(1,-1);if(n){let o=this.getFieldValue(t);if(o!==null)return String(o)}return t}getFieldValue(t){if(!this.form)return null;let n=this.form.get(t);return n?n.value:null}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{let n=Math.random()*16|0;return(t==="x"?n:n&3|8).toString(16)})}formatDate(t){return t.toISOString().split("T")[0]}formatDateTime(t){return t.toISOString().slice(0,16)}onFileSelect(t,n){let o=t.target;o.files&&(this.selectedFiles[n]=Array.from(o.files))}onAttachmentSelect(t){let n=t.target;n.files&&this.attachments.push(...Array.from(n.files))}removeAttachment(t){this.attachments.splice(t,1)}formatFileSize(t){if(t===0)return"0 Bytes";let n=1024,o=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(t)/Math.log(n));return parseFloat((t/Math.pow(n,m)).toFixed(2))+" "+o[m]}goBack(){this.router.navigate(["/workflows",this.workflowCode,"instances"])}saveDraft(){this.submitForm(!0)}onSubmit(){if(this.hasAttemptedSubmit=!0,this.validateAllFields(),this.form.invalid){this.snackBar.open("Please fill in all required fields","Close",{duration:3e3});return}if(this.pendingUniqueChecks.size>0){this.snackBar.open("Please wait for validation checks to complete","Close",{duration:3e3});return}if(Object.values(this.validationErrors).some(n=>n!==null)){this.snackBar.open("Please fix validation errors before submitting","Close",{duration:3e3});return}this.submitForm(!1)}submitForm(t){this.submitting=!0;let n=new FormData;n.append("workflowCode",this.workflowCode),n.append("isDraft",t.toString()),n.append("comments",this.form.value.comments||"");let o={};this.fields.forEach(_=>{o[_.name]=this.form.value[_.name]}),n.append("fieldValues",JSON.stringify(o)),this.attachments.forEach((_,T)=>{n.append("attachments",_)}),Object.keys(this.selectedFiles).forEach(_=>{this.selectedFiles[_].forEach(T=>{n.append(`files_${_}`,T)})}),(this.isEditMode&&this.instanceId?this.workflowService.updateInstance(this.instanceId,n):this.workflowService.submitInstance(n)).subscribe({next:_=>{if(this.submitting=!1,_.success){let T=this.isEditMode?t?"Draft updated successfully":"Submission updated successfully":t?"Draft saved successfully":"Submission created successfully";this.snackBar.open(T,"Close",{duration:3e3}),this.router.navigate(["/workflows",this.workflowCode,"instances"])}},error:_=>{this.submitting=!1,this.snackBar.open(_.error?.message||"Submission failed","Close",{duration:3e3})}})}static \u0275fac=function(n){return new(n||r)(L(_e),L(qe),L(Se),L(ne),L(te),L(Ue),L(Q))};static \u0275cmp=Z({type:r,selectors:[["app-workflow-form"]],decls:12,vars:3,consts:[["picker",""],["fileInput",""],[1,"workflow-form-container"],[1,"header"],["mat-icon-button","",3,"click"],[1,"subtitle"],[1,"loading"],[3,"formGroup"],["diameter","40"],[3,"ngSubmit","formGroup"],[1,"form-card"],[1,"form-card","group-card"],["appearance","outline",1,"full-width"],["matInput","","formControlName","comments","rows","3","placeholder","Add any additional information or comments"],[1,"form-actions"],["mat-button","","type","button",3,"click"],["mat-stroked-button","","type","button",3,"click","disabled"],["mat-raised-button","","color","primary","type","submit",3,"disabled"],["diameter","20"],[1,"fields-grid"],[1,"field-wrapper",3,"grid-column"],[1,"field-wrapper"],[1,"field-container"],[1,"radio-field",3,"has-error"],[1,"file-field",3,"has-error"],[1,"required-asterisk"],["matInput","",3,"formControlName","placeholder","readonly"],[1,"validation-error"],["matInput","","rows","4",3,"formControlName","placeholder","readonly"],["matInput","","type","number",3,"formControlName","placeholder","readonly"],["matPrefix",""],["matInput","","type","email",3,"formControlName","placeholder","readonly"],["matInput","","type","tel",3,"formControlName","placeholder","readonly"],["matInput","",3,"matDatepicker","formControlName","readonly"],["matIconSuffix","",3,"for","disabled"],[3,"disabled"],[3,"formControlName","placeholder","disabled"],[3,"value"],[1,"radio-field"],[1,"field-label"],[3,"formControlName","disabled"],[3,"value","disabled"],[1,"file-field"],["type","file",3,"change","multiple","disabled"],[1,"file-list"],["matInput","","type","url",3,"formControlName","placeholder","readonly"],[3,"expanded","hideToggle"],["matInput","","rows","4",3,"formControlName","readonly"],["matInput","","type","number",3,"formControlName","readonly"],["matInput","",3,"formControlName","readonly"],[1,"attachment-area"],["type","file","multiple","","hidden","",3,"change"],["mat-stroked-button","","type","button",3,"click"],[1,"attachment-list"],[1,"attachment-item"],[1,"size"]],template:function(n,o){n&1&&(f(0,"div",2)(1,"div",3)(2,"button",4),k("click",function(){return o.goBack()}),f(3,"mat-icon"),C(4,"arrow_back"),d()(),f(5,"div")(6,"h1"),C(7),d(),f(8,"p",5),C(9),d()()(),D(10,rt,4,0,"div",6)(11,hn,22,6,"form",7),d()),n&2&&(s(7),M(o.workflow==null?null:o.workflow.name),s(2),M(o.isEditMode?"Edit Submission":"New Submission"),s(),v(o.loading?10:o.workflow?11:-1))},dependencies:[ee,pe,ce,ae,de,le,se,me,ue,ie,De,xe,Fe,ve,Me,Te,Ne,Ie,Ae,Re,we,ye,Oe,Je,Ge,re,Qe,Ke,ze,Ze,oe,je,Xe,nt,et,tt,ge,Ce,he,Ee,fe,Ye,We,Le,$e,Ve,Pe,ke,be,He,Be],styles:[".workflow-form-container[_ngcontent-%COMP%]{padding:1rem;max-width:1000px;margin:0 auto}.header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem}.header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0}.subtitle[_ngcontent-%COMP%]{margin:0;font-size:.875rem;color:#666}.loading[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem;color:#666}.form-card[_ngcontent-%COMP%]{margin-bottom:1rem}.group-card[_ngcontent-%COMP%]{padding:0}.group-card[_ngcontent-%COMP%]   mat-expansion-panel[_ngcontent-%COMP%]{box-shadow:none}.group-card[_ngcontent-%COMP%]     .mat-expansion-panel-header{background:var(--form-field-header-bg, #1976d2)!important;color:var(--form-field-header-color, #ffffff)!important}.group-card[_ngcontent-%COMP%]     .mat-expansion-panel-header:hover{background:var(--form-field-header-bg, #1976d2)!important}.group-card[_ngcontent-%COMP%]     .mat-expansion-panel-header .mat-expansion-indicator:after{color:var(--form-field-header-color, #ffffff)!important}.group-card[_ngcontent-%COMP%]     .mat-expansion-panel-header .mat-content{color:var(--form-field-header-color, #ffffff)!important}.group-card[_ngcontent-%COMP%]     .mat-expansion-panel-header-title, .group-card[_ngcontent-%COMP%]     .mat-expansion-panel-header-description{color:var(--form-field-header-color, #ffffff)!important}.fields-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1rem 0}.field-wrapper[_ngcontent-%COMP%]{min-width:0}.full-width[_ngcontent-%COMP%]{width:100%}.field-label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-size:.875rem;color:#0009}.required[_ngcontent-%COMP%]{color:#f44336}.required-asterisk[_ngcontent-%COMP%]{color:#f44336;font-weight:700;margin-left:2px}.has-error[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_shake .3s ease-in-out}@keyframes _ngcontent-%COMP%_shake{0%,to{transform:translate(0)}25%{transform:translate(-2px)}75%{transform:translate(2px)}}.field-error[_ngcontent-%COMP%]{color:#f44336;font-size:.75rem;margin-top:4px}.field-container[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:column}.validation-error[_ngcontent-%COMP%]{color:#f44336;font-size:.75rem;margin-top:-16px;padding-left:14px;line-height:1.2}.field-invalid[_ngcontent-%COMP%]     .mdc-notched-outline__leading, .field-invalid[_ngcontent-%COMP%]     .mdc-notched-outline__notch, .field-invalid[_ngcontent-%COMP%]     .mdc-notched-outline__trailing{border-color:#f44336!important}.field-invalid[_ngcontent-%COMP%]     .mat-mdc-floating-label{color:#f44336!important}.radio-field[_ngcontent-%COMP%]   mat-radio-group[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.file-field[_ngcontent-%COMP%]{padding:.5rem 0}.file-list[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}.attachment-area[_ngcontent-%COMP%]{padding:1rem;border:2px dashed #ddd;border-radius:4px;text-align:center}.attachment-list[_ngcontent-%COMP%]{margin-top:1rem;text-align:left}.attachment-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.5rem;background:#f5f5f5;border-radius:4px;margin-bottom:.5rem}.attachment-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{flex:1}.attachment-item[_ngcontent-%COMP%]   .size[_ngcontent-%COMP%]{flex:0;color:#666;font-size:.75rem}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:1rem;margin-top:1rem}"]})}return r})();export{ti as WorkflowFormComponent};
